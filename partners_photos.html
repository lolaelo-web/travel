<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Photos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- Inline favicon -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%23ff6a3d"/></svg>' />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
  :root{
    --bg:#0b1320; --card:#111a2b; --fg:#e8eefc; --muted:#9bb0d3; --line:rgba(255,255,255,.08);
    --brand-orange:#ff6a3d; --brand-blue:#2e7bff;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg);
    background: radial-gradient(1000px 600px at 20% -10%, #1a2b4a 0%, #0b1320 60%, #0b1320 100%);
    min-height:100vh;
  }
  .page{ max-width:1100px; margin:32px auto; padding:0 16px; }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px; box-shadow:0 8px 40px rgba(0,0,0,.45); }

  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .row.between{ justify-content:space-between; align-items:center; }
  .spacer{ height:16px; }
  .muted{ color:var(--muted); font-size:12px; }

  .btn{ cursor:pointer; border-radius:999px; padding:9px 14px; font-weight:700; border:1px solid var(--brand-orange); background:var(--brand-orange); color:#111; }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  .btn-danger{ background:transparent; border-color:#b91c1c; color:#ffcfcf; }
  .btn-secondary-outline{ background:transparent; color:#d7e5ff; border-color:var(--brand-blue); }
  .btn-secondary-outline:hover{ box-shadow:0 0 0 3px rgba(46,123,255,.20) inset; }

  .input{
    border:1px solid var(--line); border-radius:10px; padding:10px 12px;
    background:#0e1830; color:var(--fg);
  }
  .input:focus{ outline:none; border-color:var(--brand-blue); box-shadow:0 0 0 3px rgba(46,123,255,.20); }

  /* Grid */
  .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; }
  @media (max-width: 960px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
  @media (max-width: 640px){ .grid{ grid-template-columns: 1fr;} }

  .ph-card{
    border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#0f1a30;
  }
  .ph-img{
    width:100%; height:220px; object-fit:cover; background:#0c1426;
    display:block;
  }
  .ph-body{ padding:10px; display:flex; flex-direction:column; gap:8px; }
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#1f2937; }
  .badge.cover{ background:#065f46; }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; }
  textarea.alt{ width:100%; min-height:40px; resize:vertical; }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="row between">
        <h1 style="margin:0;">Photos</h1>
        <button id="backBtn" class="btn btn-secondary-outline">Back to menu</button>
      </div>
      <div class="muted">
        Upload JPEG/PNG/WebP. Max size is enforced by server policy.
      </div>

      <div class="spacer"></div>

      <!-- Upload row -->
      <div class="row">
        <input id="file" type="file" accept="image/jpeg,image/png,image/webp" class="input" />
        <button id="uploadBtn" class="btn">Upload Photo</button>
        <span class="muted">Your current session is used for auth.</span>
      </div>

      <div class="spacer"></div>

      <!-- Grid list -->
      <div id="grid" class="grid" aria-live="polite"></div>
    </div>
  </div>

<script>
const BASE = 'https://lolaelo-api.onrender.com';
const ALLOWED_CT = new Set(['image/jpeg','image/png','image/webp']);

function token(){ return localStorage.getItem('lolaelo_session') || ''; }
function headers(json=true){
  const t = token();
  const h = { 'Authorization': 'Bearer ' + t, 'x-partner-token': t };
  if (json) h['Content-Type'] = 'application/json';
  return h;
}
function fmtDate(iso){ if(!iso) return ''; return new Date(iso).toLocaleString(); }

async function listPhotos(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '<div class="muted">Loading…</div>';
  const url = BASE + '/extranet/property/photos?cb=' + Date.now();
  const r = await fetch(url, { headers: headers(false), cache: 'no-store' });
  if (!r.ok){ grid.innerHTML = '<div>Failed to load ('+r.status+')</div>'; return; }
  const raw = await r.json(); const rows = Array.isArray(raw.value) ? raw.value : raw;

  grid.innerHTML = '';
  if (!rows.length){ grid.innerHTML = '<div class="muted">No photos yet.</div>'; return; }

  for (const row of rows){
    const card = document.createElement('div'); card.className='ph-card';

    const img = document.createElement('img');
    img.className = 'ph-img';
    img.src = row.url;
    img.alt = row.alt || 'Photo';
    card.appendChild(img);

    const body = document.createElement('div'); body.className='ph-body';

    const top = document.createElement('div');
    const badge = document.createElement('span');
    badge.className = 'badge' + (row.isCover ? ' cover' : '');
    badge.textContent = row.isCover ? 'COVER' : 'PHOTO';
    top.appendChild(badge);
    const meta = document.createElement('span'); meta.className='muted'; meta.style.marginLeft='8px';
    meta.textContent = fmtDate(row.createdAt);
    top.appendChild(meta);
    body.appendChild(top);

    const ta = document.createElement('textarea'); ta.className='alt input'; ta.placeholder='Alt/description…'; ta.value=row.alt||'';
    body.appendChild(ta);

    const actions = document.createElement('div'); actions.className='actions';

    const saveBtn = document.createElement('button');
    saveBtn.className='btn btn-secondary-outline'; saveBtn.textContent='Save';
    saveBtn.onclick = async () => {
      saveBtn.disabled = true;
      try{
        const rr = await fetch(BASE + '/extranet/property/photos/' + row.id, {
          method:'PUT', headers: headers(), body: JSON.stringify({ alt: ta.value })
        });
        if(!rr.ok){ const err = await rr.text(); alert('Save failed: ' + rr.status + '\n' + err); }
      } finally { saveBtn.disabled = false; }
    };
    actions.appendChild(saveBtn);

    const coverBtn = document.createElement('button');
    coverBtn.className='btn'; coverBtn.textContent='Make Cover';
    coverBtn.disabled = !!row.isCover;
    coverBtn.onclick = async () => {
      coverBtn.disabled = true;
      try{
        const rr = await fetch(BASE + '/extranet/property/photos/' + row.id, {
          method:'PUT', headers: headers(), body: JSON.stringify({ isCover: true })
        });
        if(!rr.ok){ const err = await rr.text(); alert('Cover failed: ' + rr.status + '\n' + err); }
        else { await listPhotos(); }
      } finally { coverBtn.disabled = false; }
    };
    actions.appendChild(coverBtn);

    const delBtn = document.createElement('button');
    delBtn.className='btn btn-danger'; delBtn.textContent='Delete';
    delBtn.onclick = async () => {
      if (!confirm('Delete this photo?')) return;
      delBtn.disabled = true;
      try{
        const rr = await fetch(BASE + '/extranet/property/photos/' + row.id, {
          method:'DELETE', headers: headers(false)
        });
        if(!rr.ok && rr.status !== 204){ const err = await rr.text(); alert('Delete failed: ' + rr.status + '\n' + err); }
        else { await listPhotos(); }
      } finally { delBtn.disabled = false; }
    };
    actions.appendChild(delBtn);

    body.appendChild(actions);
    card.appendChild(body);
    grid.appendChild(card);
  }
}

async function upload(){
  const f = document.getElementById('file').files[0];
  if (!f) return alert('Pick a file first.');
  if (!ALLOWED_CT.has(f.type)) return alert('Unsupported type: ' + f.type);

  // 1) presign
  const r1 = await fetch(BASE + '/extranet/property/photos/upload-url', {
    method:'POST', headers: headers(), body: JSON.stringify({ fileName: f.name, contentType: f.type, size: f.size })
  });
  if (!r1.ok){ const e = await r1.text(); return alert('upload-url failed: ' + r1.status + '\n' + e); }
  const up = await r1.json();

  // 2) PUT to S3
  const r2 = await fetch(up.uploadUrl, { method:'PUT', headers: up.headers, body: f });
  if (!r2.ok) return alert('S3 PUT failed: ' + r2.status);

  // 3) create DB row; we can try to read dimensions client-side
  let width = null, height = null;
  try {
    const img = new Image();
    img.src = URL.createObjectURL(f);
    await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; });
    width = img.naturalWidth || null; height = img.naturalHeight || null;
  } catch {}

  const r3 = await fetch(BASE + '/extranet/property/photos', {
    method:'POST', headers: headers(),
    body: JSON.stringify({ key: up.key, url: up.url, alt: f.name, width, height, isCover: false })
  });
  if (!r3.ok){ const err = await r3.text(); return alert('Create failed: ' + r3.status + '\n' + err); }

  await listPhotos(); alert('Uploaded.');
}

document.getElementById('uploadBtn').addEventListener('click', upload);
document.getElementById('backBtn').addEventListener('click', () => { window.location.href = '/partners_app.html'; });

// Ensure refresh on bfcache restore or after login redirects
window.addEventListener('pageshow', () => { if (typeof listPhotos === 'function') listPhotos(); });

// Initial load
listPhotos();
</script>
</body>
</html>
