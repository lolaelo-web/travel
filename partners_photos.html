<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Photos — Lolaelo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b1320; --card:#111a2b; --fg:#e8eefc; --muted:#9bb0d3; --line:rgba(255,255,255,.08); --accent:#ff6a3d; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; color:var(--fg);
          background: radial-gradient(1000px 600px at 20% -10%, #1a2b4a 0%, #0b1320 60%, #0b1320 100%); }
    .page{ max-width:980px; margin:28px auto; padding:0 16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px; box-shadow:0 8px 40px rgba(0,0,0,.45); }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .muted{ color:var(--muted) }
    .btn{ appearance:none; border:1px solid var(--accent); background:var(--accent); color:#111; padding:9px 14px; border-radius:999px; font-weight:700; cursor:pointer; }
    .btn.secondary{ background:transparent; border-color:#2e7bff; color:#d7e5ff }
    .btn.ghost{ background:transparent; border-color:var(--line); color:#cfe0ff }
    .photos{ display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; margin-top:12px }
    .ph{ background:#0e1830; border:1px solid var(--line); border-radius:12px; padding:10px }
    .ph img{ width:100%; height:120px; object-fit:cover; border-radius:8px; display:block }
    .meta{ font-size:12px; color:#a9bbde; margin-top:6px; word-break:break-word }
    .actions{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="row">
        <h1 style="margin:0">Your Photos</h1>
        <a class="btn secondary" href="/partners_app.html">Back to menu</a>
      </div>
      <div id="msg" class="muted">Loading…</div>
      <div id="grid" class="photos" aria-live="polite"></div>
    </div>
  </div>

<script>
  // Use Render API when hosted on lolaelo.com; otherwise same-origin (for testing)
  const API_BASE = (location.hostname.endsWith('lolaelo.com'))
    ? 'https://lolaelo-api.onrender.com'
    : location.origin;

  function getToken(){
    try {
      if (window.TravelAuth && typeof TravelAuth.getToken === 'function') {
        const t = TravelAuth.getToken(); if (t) return t;
      }
    } catch {}
    return localStorage.getItem('partnerToken') || localStorage.getItem('lolaelo_session') || '';
  }

  async function authed(path, opts={}){
    const t = getToken();
    const isGet = !opts.method || opts.method.toUpperCase()==='GET';
    const bust = isGet ? (path.includes('?') ? '&' : '?') + '__ts=' + Date.now() : '';
    const url = API_BASE + path + bust;
    return fetch(url, {
      cache:'no-store',
      ...opts,
      headers: { ...(opts.headers||{}), 'Authorization': 'Bearer ' + t }
    });
  }

  function render(list){
    const grid = document.getElementById('grid');
    const msg  = document.getElementById('msg');
    grid.innerHTML = '';
    if (!Array.isArray(list) || !list.length){
      msg.textContent = 'No photos yet.'; return;
    }
    msg.textContent = '';
    list
      .sort((a,b)=> (b.isCover?1:0)-(a.isCover?1:0) || (a.sortOrder??0)-(b.sortOrder??0) || a.id-b.id)
      .forEach(p=>{
        const card = document.createElement('div'); card.className='ph';
        const img  = document.createElement('img'); img.src=p.url; img.alt=p.alt||'';
        const meta = document.createElement('div'); meta.className='meta';
        meta.textContent = (p.isCover?'[COVER] ':'') + (p.alt || p.key || p.url);
        card.appendChild(img); card.appendChild(meta); grid.appendChild(card);
      });
  }

  async function load(){
    const msg = document.getElementById('msg');
    try{
      const r = await authed('/extranet/property/photos');
      const body = await r.text();
      if (!r.ok) { msg.textContent = `Error ${r.status}`; return; }
      // API may return {value:[...] } or plain array
      let data; try{ data = JSON.parse(body); }catch{ data = []; }
      const rows = Array.isArray(data) ? data : (Array.isArray(data.value) ? data.value : []);
      render(rows);
    }catch(e){
      console.error(e); msg.textContent = 'Failed to load photos.';
    }
  }

  (document.readyState==='loading')
    ? document.addEventListener('DOMContentLoaded', load)
    : load();
</script>
</body>
</html>
